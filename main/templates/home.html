{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Peak Performance Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-pink-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section -->
    <div class="mb-8 text-center">
      <h1 class="text-3xl font-extrabold text-gray-900 mb-2">
        ‚ú® Latest Products ‚ú®
      </h1>
      <p class="text-pink-500">Reach your peak with a touch of style</p>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-2xl border border-pink-200 p-4 shadow-sm">
      <div class="flex flex-wrap gap-3 mb-4 sm:mb-0">
        <button onclick="loadProducts('all')" 
           class="filter-btn bg-pink-500 text-white px-4 py-2 rounded-full font-medium transition-colors hover:bg-pink-600">
          All Products
        </button>
        <button onclick="loadProducts('my')" 
           class="filter-btn bg-white text-gray-700 border border-pink-300 px-4 py-2 rounded-full font-medium transition-colors hover:bg-pink-600 hover:text-white">
          My Products
        </button>
        <button onclick="openAddProductModal()" 
           class="bg-green-500 text-white px-4 py-2 rounded-full font-medium transition-colors hover:bg-green-600 shadow">
          ‚ûï Add Product
        </button>
        <button onclick="loadProducts()" 
           class="bg-blue-500 text-white px-4 py-2 rounded-full font-medium transition-colors hover:bg-blue-600 shadow">
          üîÑ Refresh
        </button>
        <button id="sortButton" onclick="urutinHarga()" data-sort="asc"
           class="bg-yellow-500 text-white px-4 py-2 rounded-full font-medium transition-colors hover:bg-yellow-600 shadow">
          üìä Urutkan Harga
        </button>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500 italic">
          ‚è±Ô∏è Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <!-- Products Container -->
    <div id="productsContainer">
      <!-- Loading State -->
      <div id="loadingState" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Loading products...</p>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden bg-white rounded-2xl border border-pink-200 p-12 text-center shadow-md">
        <div class="w-32 h-32 mx-auto mb-4 relative">
          <div class="absolute inset-0 bg-pink-100 rounded-full animate-pulse"></div>
          <img src="{% static 'image/no-products.png' %}" alt="No products available" class="w-full h-full object-contain relative z-10">
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No products found</h3>
        <p class="text-pink-500 mb-6">Nothing here yet ‚Äî your peak awaits!</p>
        <button onclick="openAddProductModal()" 
           class="inline-flex items-center px-5 py-2 bg-pink-500 text-white rounded-full hover:bg-pink-600 transition-colors shadow">
          ‚ûï Create Product
        </button>
      </div>

      <!-- Products Grid -->
      <div id="productsGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Products will be loaded here by JavaScript -->
      </div>
    </div>
  </div>
</div>

<script>
  let currentFilter = 'all';

  // Load products on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
  });

  // Load products with filter
  async function loadProducts(filter = 'all') {
    currentFilter = filter;
    
    // Show loading state
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('productsGrid').classList.add('hidden');
    
    // Update active filter button
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('bg-pink-500', 'text-white');
      btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-pink-300');
    });
    
    // Find and activate the current filter button
    const activeButton = Array.from(document.querySelectorAll('.filter-btn')).find(btn => 
      btn.textContent.toLowerCase().includes(filter)
    );
    if (activeButton) {
      activeButton.classList.remove('bg-white', 'text-gray-700', 'border', 'border-pink-300');
      activeButton.classList.add('bg-pink-500', 'text-white');
    }

    try {
      console.log(`Loading products with filter: ${filter}`);
      
      const response = await fetch(`/get-products/?filter=${filter}`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const products = await response.json();
      console.log('Products loaded:', products);
      displayProducts(products);
      
    } catch (error) {
      console.error('Error loading products:', error);
      showError('Failed to load products: ' + error.message);
      
      // Hide loading state on error
      document.getElementById('loadingState').classList.add('hidden');
    }
  }



  // Display products in grid
  function displayProducts(products) {
    const productsGrid = document.getElementById('productsGrid');
    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    
    loadingState.classList.add('hidden');
    
    if (!products || products.length === 0) {
      emptyState.classList.remove('hidden');
      productsGrid.classList.add('hidden');
      return;
    }
    
    emptyState.classList.add('hidden');
    productsGrid.classList.remove('hidden');
    
    productsGrid.innerHTML = products.map(product => `
      <article class="bg-white rounded-2xl border border-pink-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden">
        <!-- Thumbnail -->
        <div class="aspect-[16/9] relative overflow-hidden rounded-t-2xl">
          ${product.thumbnail ? 
            `<img src="${product.thumbnail}" alt="${product.name}" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-300">` :
            `<div class="w-full h-full bg-pink-50 flex items-center justify-center text-pink-300">No Image</div>`
          }

          <!-- Category Badge -->
          <div class="absolute top-3 left-3">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-pink-500 text-white shadow-sm">
              ${product.category_display || product.category}
            </span>
          </div>

          <!-- Status Badges -->
          <div class="absolute top-3 right-3 flex space-x-2">
            ${product.is_featured ? 
              `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-200 text-yellow-900">‚òÖ Featured</span>` : ''}
            ${product.is_product_hot ? 
              `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-200 text-red-800">üî• Hot</span>` : ''}
          </div>
        </div>

        <!-- Content -->
        <div class="p-5">
          <div class="flex items-center text-xs text-gray-400 mb-3">
            <time>${product.created_at || 'Unknown date'}</time>
            <span class="mx-2">‚Ä¢</span>
            <span>${product.product_views || 0} views</span>
          </div>

          <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight">
            <a href="/product/${product.id}/" class="hover:text-pink-600 transition-colors">
              ${product.name}
            </a>
          </h3>

          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">
            ${product.description || 'No description available'}
          </p>

          <p class="text-lg font-semibold text-pink-600 mb-4">
            $${(product.price || 0).toLocaleString()}.00
          </p>

          <!-- Action Buttons -->
          <div class="flex items-center justify-between pt-4 border-t border-pink-100">
            <a href="/product/${product.id}/" class="text-pink-600 hover:text-pink-700 font-medium text-sm transition-colors">
              Read more
            </a>
            ${product.is_owner ? `
              <div class="flex space-x-3">
                <button onclick="openEditProductModal(${product.id})" class="text-gray-500 hover:text-gray-700 text-sm transition-colors">
                  ‚úèÔ∏è Edit
                </button>
                <button onclick="openDeleteModal(${product.id})" class="text-red-500 hover:text-red-600 text-sm transition-colors">
                  üóëÔ∏è Delete
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      </article>
    `).join('');
  }
</script>
{% endblock content %}